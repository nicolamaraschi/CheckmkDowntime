import { Amplify } from 'aws-amplify';
import {
  signIn as amplifySignIn,
  signOut as amplifySignOut,
  getCurrentUser as amplifyGetCurrentUser,
  fetchAuthSession,
  confirmSignIn as amplifyConfirmSignIn,
  setUpTOTP as amplifySetUpTOTP,
  verifyTOTPSetup,
  updateMFAPreference,
} from '@aws-amplify/auth';

// Configurazione Cognito
Amplify.configure({
  Auth: {
    region: 'eu-west-1',
    userPoolId: 'eu-west-1_E3d6JEkfX',
    userPoolWebClientId: '5v6sqab99b9mbb7es880cg6mjc',
    mandatorySignIn: true,
    authenticationFlowType: 'USER_PASSWORD_AUTH'
  }
});

export const signIn = async (username, password) => {
  try {
    const output = await amplifySignIn({ username, password });

    // Controlla se è richiesto il cambio password
    if (output.nextStep?.signInStep === 'CONFIRM_SIGN_IN_WITH_NEW_PASSWORD_REQUIRED') {
      return {
        success: false,
        requireNewPassword: true,
        user: output,
        error: { message: 'E richiesto il cambio password' }
      };
    }

    // Controlla se è richiesta la configurazione MFA
    if (output.nextStep?.signInStep === 'CONTINUE_SIGN_IN_WITH_TOTP_SETUP') {
      return {
        success: false,
        requireMfaSetup: true,
        user: output,
        error: { message: 'E richiesta la configurazione MFA' }
      };
    }

    // Controlla se è richiesta la verifica MFA
    if (output.nextStep?.signInStep === 'CONFIRM_SIGN_IN_WITH_TOTP_CODE') {
      return {
        success: false,
        requireMfaVerification: true,
        user: output,
        error: { message: 'E richiesta la verifica MFA' }
      };
    }

    // Login completato
    if (output.isSignedIn) {
      return { success: true, user: output };
    }

    return { success: false, error: { message: 'Login non completato' } };
  } catch (error) {
    console.error('Error signing in:', error);
    return { success: false, error };
  }
};

export const completeNewPassword = async (signInOutput, newPassword) => {
  try {
    const output = await amplifyConfirmSignIn({
      challengeResponse: newPassword
    });
    return { success: true, user: output };
  } catch (error) {
    console.error('Error completing new password:', error);
    return { success: false, error };
  }
};

export const signOut = async () => {
  try {
    await amplifySignOut();
    return { success: true };
  } catch (error) {
    console.error('Error signing out:', error);
    return { success: false, error };
  }
};

export const getCurrentUser = async () => {
  try {
    const user = await amplifyGetCurrentUser();
    return { success: true, user };
  } catch (error) {
    console.error('Error getting current user:', error);
    return { success: false, error };
  }
};

export const getToken = async () => {
  try {
    const session = await fetchAuthSession();
    return session.tokens?.idToken?.toString();
  } catch (error) {
    console.error('Error getting token:', error);
    return null;
  }
};

// MFA Functions
export const confirmSignIn = async (signInOutput, code, mfaType = 'TOTP') {
  try {
    const output = await amplifyConfirmSignIn({
      challengeResponse: code
    });
    return { success: true, user: output };
  } catch (error) {
    console.error('Error confirming sign in:', error);
    return { success: false, error };
  }
};

export const setupTOTP = async (signInOutput) => {
  try {
    const totpSetupDetails = await amplifySetUpTOTP();
    const code = totpSetupDetails.sharedSecret;
    return { success: true, code, setupDetails: totpSetupDetails };
  } catch (error) {
    console.error('Error setting up TOTP:', error);
    return { success: false, error };
  }
};

export const verifyTotpToken = async (signInOutput, challengeAnswer) => {
  try {
    await verifyTOTPSetup({ code: challengeAnswer });
    // After verifying, confirm the sign in
    const output = await amplifyConfirmSignIn({
      challengeResponse: challengeAnswer
    });
    return { success: true, user: output };
  } catch (error) {
    console.error('Error verifying TOTP token:', error);
    return { success: false, error };
  }
};

export const setPreferredMFA = async (user, mfaType) => {
  try {
    await updateMFAPreference({ totp: 'PREFERRED' });
    return { success: true };
  } catch (error) {
    console.error('Error setting preferred MFA:', error);
    return { success: false, error };
  }
};

// Esporta le singole funzioni e un oggetto di default
const authExports = {
  signIn,
  completeNewPassword,
  signOut,
  getCurrentUser,
  getToken,
  confirmSignIn,
  setupTOTP,
  verifyTotpToken,
  setPreferredMFA
};
export default authExports;
